raw_response = """{"id":"chatcmpl-8SMKHbKT4KeDeoR9kLFZYbivme9XM","choices":[{"finish_reason":"length","index":0,"message":{"content":null,"role":"assistant","function_call":{"arguments":"{\n  \"meeting_titl
e\": \"CTAS County Commission Meeting\",\n  \"date\": \"July 15, 2021\",\n  \"location\": \"County Hall\",\n  \"chairperson\": \"Chairman Wormsley\",\n  \"participants\": [\n    {\"name\":
 \"Chairman Wormsley\", \"role\": \"Chairperson\"},\n    {\"name\": \"Commissioner Brown\", \"role\": null},\n    {\"name\": \"Commissioner Hobbs\", \"role\": null},\n    {\"name\": \"Comm
issioner McCroskey\", \"role\": null},\n    {\"name\": \"Commissioner Adkins\", \"role\": null},\n    {\"name\": \"Commissioner Carmical\", \"role\": null},\n    {\"name\": \"Commissioner 
McKee\", \"role\": null},\n    {\"name\": \"Commissioner Rodgers\", \"role\": null},\n    {\"name\": \"Commissioner Duckett\", \"role\": null},\n    {\"name\": \"Commissioner Reinhart\", \
"role\": null},\n    {\"name\": \"Commissioner Malone\", \"role\": null},\n    {\"name\": \"Commissioner Headrick\", \"role\": null},\n    {\"name\": \"County Attorney Fults\", \"role\": n
ull},\n    {\"name\": \"Commissioner Adams\", \"role\": null},\n    {\"name\": \"Commissioner Crenshaw\", \"role\": null},\n    {\"name\": \"Commissioner Thompson\", \"role\": null},\n    
{\"name\": \"Commissioner Hayes\", \"role\": null},\n    {\"name\": \"Commissioner Hailey\", \"role\": null},\n    {\"name\": \"Commissioner Austin\", \"role\": null},\n    {\"name\": \"Co
mmissioner Garland\", \"role\": null}\n  ],\n  \"agenda\": [\n    {\"title\": \"Call to Order and Roll Call\"},\n    {\"title\": \"Approval of Agenda\"},\n    {\"title\": \"Approval of Min
utes\"},\n    {\"title\": \"Resolution on Data Processing Reserve Account\"},\n    {\"title\": \"Old Business - Motion to Sell Property\"},\n    {\"title\": \"Resolution on State Match Loc
al Litigation Tax\"},\n    {\"title\": \"New Business - Resolution on Wheel Tax\"},\n    {\"title\": \"Announcements\"},\n    {\"title\": \"Adjournment\"}\n  ],\n  \"discussions\": [\n    
{\"speaker\": \"Chairman Wormsley\", \"content\": \"This meeting of the CTAS County Commission will come to order. Clerk please call the role.\"},\n    {\"speaker\": \"Chairman Wormsley\",
 \"content\": \"Each of you has received the agenda. I will entertain a motion that the agenda be approved.\"},\n    {\"speaker\": \"Commissioner Brown\", \"content\": \"So moved.\"},\n   
 {\"speaker\": \"Commissioner Hobbs\", \"content\": \"Seconded\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"It has been moved and seconded that the agenda be approved as re
ceived by the members. All those in favor signify by saying 'Aye'?...Opposed by saying 'No'?...The agenda is approved.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"You have
 received a copy of the minutes of the last meeting. Are there any corrections or additions to the meeting?\"},\n    {\"speaker\": \"Commissioner McCroskey\", \"content\": \"Mister Chairma
n, my name has been omitted from the Special Committee on Indigent Care.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Thank you. If there are no objections, the minutes wil
l be corrected to include the name of Commissioner McCroskey. Will the clerk please make this correction. Any further corrections? Seeing none, without objection the minutes will stand app
roved as read.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Commissioner Adkins, the first item on the agenda is yours.\"},\n    {\"speaker\": \"Commissioner Adkins\", \"co
ntent\": \"Mister Chairman, I would like to make a motion to approve the resolution taking money from the Data Processing Reserve Account in the County Clerk's office and moving it to the 
equipment line to purchase a laptop computer.\"},\n    {\"speaker\": \"Commissioner Carmical\", \"content\": \"I second the motion.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\
": \"This resolution has a motion and second. Will the clerk please take the vote.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"The resolution passes.\"},\n    {\"speaker\"
: \"Chairman Wormsley\", \"content\": \"We will now take up old business. At our last meeting, Commissioner McKee, your motion to sell property near the airport was deferred to this meetin
g. You are recognized.\"},\n    {\"speaker\": \"Commissioner McKee\", \"content\": \"I move to withdraw that motion.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Commission
er McKee has moved to withdraw his motion to sell property near the airport. Seeing no objection, this motion is withdrawn.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"The
 next item on the agenda is Commissioner Rodgers'.\"},\n    {\"speaker\": \"Commissioner Rodgers\", \"content\": \"I move adoption of the resolution previously provided to each of you to i
ncrease the state match local litigation tax in circuit, chancery, and criminal courts to the maximum amounts permissible. This resolution calls for the increases to go to the general fund
.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Commissioner Duckett\"},\n    {\"speaker\": \"Commissioner Duckett\", \"content\": \"The sheriff is opposed to this increase.
\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Commissioner, you are out of order because this motion has not been seconded as needed before the floor is open for discussion
 or debate. Discussion will begin after we have a second. Is there a second?\"},\n    {\"speaker\": \"Commissioner Reinhart\", \"content\": \"For purposes of discussion, I second the motio
n.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Commissioner Rodgers is recognized.\"},\n    {\"speaker\": \"Commissioner Rodgers\", \"content\": \"(Speaks about the data o
n collections, handing out all sorts of numerical figures regarding the litigation tax, and the county's need for additional revenue.)\"},\n    {\"speaker\": \"Chairman Wormsley\", \"conte
nt\": \"Commissioner Duckett\"},\n    {\"speaker\": \"Commissioner Duckett\", \"content\": \"I move an amendment to the motion to require 25 percent of the proceeds from the increase in th
e tax on criminal cases go to fund the sheriff's department.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Commissioner Malone\"},\n    {\"speaker\": \"Commissioner Malone\"
, \"content\": \"I second the amendment.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"A motion has been made and seconded to amend the motion to increase the state match lo
cal litigation taxes to the maximum amounts to require 25 percent of the proceeds from the increase in the tax on criminal cases in courts of record going to fund the sheriff's department.
 Any discussion? Will all those in favor please raise your hand? All those opposed please raise your hand. The amendment carries 17-2. We are now on the motion as amended. Any further disc
ussion?\"},\n    {\"speaker\": \"Commissioner Headrick\", \"content\": \"Does this require a two-thirds vote?\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Will the county a
ttorney answer that question?\"},\n    {\"speaker\": \"County Attorney Fults\", \"content\": \"Since these are only courts of record, a majority vote will pass it. The two-thirds requireme
nt is for the general sessions taxes.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Other questions or discussion? Commissioner Adams.\"},\n    {\"speaker\": \"Commissioner 
Adams\", \"content\": \"Move for a roll call vote.\"},\n    {\"speaker\": \"Commissioner Crenshaw\", \"content\": \"Second\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"The 
motion has been made and seconded that the state match local litigation taxes be increased to the maximum amounts allowed by law with 25 percent of the proceeds from the increase in the ta
x on criminal cases in courts of record going to fund the sheriff's department. Will all those in favor please vote as the clerk calls your name, those in favor vote 'aye,' those against v
ote 'no.' Nine votes for, nine votes against, one not voting. The increase fails.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"We are now on new business. Commissioner Adki
ns, the first item on the agenda is yours.\"},\n    {\"speaker\": \"Commissioner Adkins\", \"content\": \"Each of you has previously received a copy of a resolution to increase the wheel t
ax by $10 to make up the state cut in education funding. I move adoption of this resolution.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Commissioner Thompson\"},\n    {\"
speaker\": \"Commissioner Thompson\", \"content\": \"I second.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"It has been properly moved and seconded that a resolution increa
sing the wheel tax by $10 to make up the state cut in education funding be passed. Any discussion?\"},\n    {\"speaker\": \"Commissioner Hayes\", \"content\": \"I move previous question.\"
},\n    {\"speaker\": \"Commisioner Crenshaw\", \"content\": \"Second.\"},\n    {\"speaker\": \"Chairman Wormsley\", \"content\": \"Previous question has been moved and seconded. As you kn
ow, a motion for previous question, if passed by a two-thirds vote, will cut off further debate and require us to vote yes or no on the resolution before us. You should vote for this motio
n if you wish to cut off further debate of the wheel tax increase at this point. Will all those in favor of previous question please raise your hand? Will all those against please raise yo
ur hand? The vote is 17-2. Previous question passes. We are now on the motion to increase the wheel tax by $10 to make up the state cut in education funding. Will all those in favor please
 raise your hand? Will all those against please raise your hand? The","name":"MeetingMinutes"},"tool_calls":null}}],"created":1701769697,"model":"gpt-3.5-turbo-0613","object":"chat.completion","system_fingerprint":null,"usage":{"completion_tokens":2149,"prompt_tokens":1949,"total_tokens":4098}}
"""

import base64
import json
from datetime import datetime
from pydantic import BaseModel, Field
from instructor import OpenAISchema
from typing import List, Optional
from datetime import datetime
import streamlit as st
import openai
from enum import Enum
from dotenv import load_dotenv
load_dotenv()


class Participant(BaseModel):
    name: str = Field(..., description="The full name of the meeting participant.")
    role: Optional[str] = Field(None, description="The role or title of the participant within the meeting.")

class AgendaItem(BaseModel):
    title: str = Field(..., description="The title or topic of the agenda item.")
    description: Optional[str] = Field(None, description="A brief description of the agenda item.")

class DiscussionPoint(BaseModel):
    speaker: str = Field(..., description="The name of the person speaking on this point.")
    content: str = Field(..., description="The content or substance of the discussion point.")

class Motion(BaseModel):
    proposed_by: str = Field(..., description="The name of the person who proposed the motion.")
    seconded_by: str = Field(..., description="The name of the person who seconded the motion.")
    description: str = Field(..., description="A detailed description of what the motion entails.")
    result: Optional[str] = Field(None, description="The result of the motion, e.g., passed, failed, tabled.")

class PriorityEnum(str, Enum):
    high = "High"
    medium = "Medium"
    low = "Low"

class Subtask(BaseModel):
    """Subtask derived from the transcript."""
    id: int
    name: str

class Ticket(BaseModel):
    """Ticket representing an action item derived from the transcript."""
    id: int
    name: str
    description: str
    priority: PriorityEnum
    assignees: List[str] = Field(default_factory=list)
    subtasks: Optional[List[Subtask]] = None
    dependencies: Optional[List[int]] = None

class ActionItems(BaseModel):
    """Collection of action items extracted from the transcript."""
    items: List[Ticket]

class MeetingMinutes(OpenAISchema):  # Assuming OpenAISchema is a BaseModel
    meeting_title: str = Field(..., description="The official title of the meeting.")
    date: datetime = Field(..., description="The date and time when the meeting took place.")
    location: str = Field(..., description="The physical or virtual location of the meeting.")
    chairperson: str = Field(..., description="The name of the individual chairing the meeting.")
    participants: List[Participant] = Field(..., description="A list of participants who attended the meeting.")
    agenda: List[AgendaItem] = Field(..., description="A list of agenda items discussed during the meeting.")
    discussions: List[DiscussionPoint] = Field(..., description="A list of discussion points covered in the meeting.")
    motions: Optional[List[Motion]] = Field(None, description="A list of motions proposed and voted on during the meeting.")
    actions: Optional[ActionItems] = Field(None, description="A list of action items derived from the meeting transcript.")
    conclusions: Optional[str] = Field(None, description="Conclusions or summary of the meeting outcomes.")
    next_meeting_date: Optional[datetime] = Field(None, description="The scheduled date and time for the next meeting.")
    next_meeting_agenda: Optional[str] = Field(None, description="A preliminary agenda for the next meeting.")


client = openai.OpenAI()

def generate_action_items(transcript: str, model: str) -> MeetingMinutes:
    response = client.chat.completions.create(
        model=model,
        messages=[
            {"role": "system", "content": "Extract meeting minutes from the following transcript:"},
            {"role": "user", "content": transcript},
        ],
        functions=[MeetingMinutes.openai_schema],
        function_call="auto",
        temperature=0.0
    )
    return response

def model_to_markdown(model: BaseModel) -> str:
    markdown_output = []

    def process_field(field_name, value):
        if isinstance(value, list):
            for item in value:
                if isinstance(item, BaseModel):
                    process_model(item)
                else:
                    markdown_output.append(f"- {item}\n")
        elif isinstance(value, BaseModel):
            process_model(value)
        else:
            markdown_output.append(f"**{field_name.replace('_', ' ').capitalize()}**: {value}\n")

    def process_model(sub_model: BaseModel):
        for field_name, field_value in sub_model:
            if field_value is not None:
                process_field(field_name, field_value)

    process_model(model)
    return ''.join(markdown_output)

def download_link(object_to_download, download_filename, download_link_text):
    """
    Generates a link to download the given object_to_download.
    """
    try:
        b64 = base64.b64encode(object_to_download.encode()).decode()
        return f'<a href="data:file/txt;base64,{b64}" download="{download_filename}">{download_link_text}</a>'
    except Exception as e:
        return str(e)

def reformat_and_parse_json(input_string):
    try:
        # Remove line breaks and escape double quotes
        formatted_string = input_string.replace("\n", " ").replace('\"', '\\"')

        # Parse the formatted JSON string
        json_data = json.loads(formatted_string)
        return json_data
    except json.JSONDecodeError as e:
        return f"Error parsing JSON: {e}"
    except Exception as e:
        return f"An unexpected error occurred: {e}"


def serialize_completion(completion):
    return {
        "id": completion.id,
        "choices": [
            {
                "finish_reason": choice.finish_reason,
                "index": choice.index,
                "message": {
                    "content": choice.message.content,
                    "role": choice.message.role,
                    "function_call": {
                        "arguments": json.loads(
                            choice.message.function_call.arguments) if choice.message.function_call and choice.message.function_call.arguments else None,
                        "name": choice.message.function_call.name
                    } if choice.message and choice.message.function_call else None
                } if choice.message else None
            } for choice in completion.choices
        ],
        "created": completion.created,
        "model": completion.model,
        "object": completion.object,
        "system_fingerprint": completion.system_fingerprint,
        "usage": {
            "completion_tokens": completion.usage.completion_tokens,
            "prompt_tokens": completion.usage.prompt_tokens,
            "total_tokens": completion.usage.total_tokens
        }
    }


st.title("Meeting Action Item Extractor")

# Show OpenAI schema checkbox
if st.checkbox("Show OpenAI schema", value=False, key="show_schema"):
    st.json(MeetingMinutes.openai_schema)

# Meeting transcript input
transcript = st.text_area("Enter Meeting Transcript:", height=300)

# OpenAI model selection
model = st.selectbox("Select OpenAI Model:", ["gpt-3.5-turbo", "gpt-4-1106-preview", "gpt-3.5-turbo-1106"])

# Process and generate meeting minutes
if st.button("Create Minutes"):
    with st.spinner("Generating meeting minutes..."):
        if transcript:
            try:
                action_items = generate_action_items(transcript, model)
                raw_response = serialize_completion(action_items)
                print(raw_response)  # For debugging
                st.subheader("Raw Response:")
                st.write(raw_response)
                st.subheader("Raw Response (JSON):")
                st.json(raw_response)
                try:
                    # Extracting the specific part of the response
                    meeting_minutes_data = raw_response["choices"][0]["message"]["function_call"]["arguments"]
                    #meeting_minutes_data = raw_response.choices.message.function_call.arguments

                    if isinstance(meeting_minutes_data, dict):
                        meeting_minutes = MeetingMinutes(**meeting_minutes_data)
                        markdown_document = model_to_markdown(meeting_minutes)
                        st.subheader("Meeting Minutes:")
                        st.markdown(markdown_document, unsafe_allow_html=True)
                        st.markdown(download_link(markdown_document, "meeting_minutes.txt", "Download Meeting Minutes as TXT"), unsafe_allow_html=True)
                    else:
                        st.error("Invalid response format for meeting minutes.")
                except Exception as e:
                    st.error(f"An error occurred while processing the response: {e}")
            except Exception as e:
                st.error(f"An error occurred while generating action items: {e}")
        else:
            st.warning("Please enter a transcript to extract action items from.")
